define(['jquery', 'core/log', 'core/ajax'], function ($, log, ajax) {
    return {
        init: function (elementId, url, cmid) {
            log.debug('MediaCMS: Initializing for ' + elementId);

            require(['media_videojs/video-lazy'], function (videojs) {
                var options = {
                    controls: true,
                    autoplay: false,
                    preload: 'auto',
                    fluid: true,
                    playbackRates: [0.5, 0.75, 1, 1.25, 1.5, 1.75, 2],
                    sources: [{
                        src: url,
                        type: 'video/mp4' // Default assumption, or needs to be dynamic
                    }]
                };

                var player = videojs(elementId, options);

                player.ready(function () {
                    log.debug('MediaCMS: Player ready');

                    var lastUpdate = 0;

                    player.on('timeupdate', function () {
                        var currentTime = player.currentTime();
                        var duration = player.duration();

                        if (duration > 0) {
                            var percentage = Math.floor((currentTime / duration) * 100);

                            // Send update if percentage increased by at least 1% or reached 100%
                            // To reduce traffic we can throttle, but user asked for >90% completion.
                            // We'll update every 5% to be safe and avoid flooding.
                            if (percentage > lastUpdate && (percentage % 5 === 0 || percentage >= 90)) {
                                lastUpdate = percentage;

                                ajax.call([{
                                    methodname: 'mod_mediacms_submit_progress',
                                    args: { cmid: cmid, progress: percentage }
                                }])[0].fail(function (ex) {
                                    log.error('MediaCMS: Failed to update progress: ' + ex);
                                });
                            }
                        }
                    });

                    player.on('ended', function () {
                        ajax.call([{
                            methodname: 'mod_mediacms_submit_progress',
                            args: { cmid: cmid, progress: 100 }
                        }]);
                        lastUpdate = 100;
                    });
                });
            }, function (err) {
                // Fallback if media_videojs is not found
                log.warn('MediaCMS: media_videojs not found, falling back to native controls');
                // The video tag already has 'controls' attribute, so native player will handle it.
            });
        }
    };
});
